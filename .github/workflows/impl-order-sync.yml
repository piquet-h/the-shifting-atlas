name: Implementation Order Sync

# Explicit permissions required:
# - repository-projects: write   -> needed to update GitHub Projects (Projects v2) fields via GraphQL in sync script
# - issues: write                -> label reconciliation / creation
# - contents: write              -> committing regenerated docs & JSON ordering file
# Keep the list tight (principle of least privilege).
permissions:
    contents: write
    issues: write
    repository-projects: write # Classic projects; Projects v2 still require a PAT with project scope

on:
    workflow_dispatch:
        inputs:
            mode:
                description: 'Operation mode (validate|apply|resequence)'
                required: false
                default: 'apply'
    push:
        paths:
            - 'roadmap/implementation-order.json'
            - 'scripts/sync-implementation-order.mjs'
            - '.github/workflows/impl-order-sync.yml'
            - '.github/copilot-instructions.md'

jobs:
    sync:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install minimal deps
              run: npm ci --omit=dev || true

            - name: Select token (PROJECTS_TOKEN overrides GITHUB_TOKEN)
              id: select-token
              run: |
                  if [ -n "${{ secrets.PROJECTS_TOKEN }}" ]; then
                    echo "token=${{ secrets.PROJECTS_TOKEN }}" >> "$GITHUB_OUTPUT"
                    echo "Using PROJECTS_TOKEN secret (expected to have 'project' scope for Projects v2)."
                  else
                    echo "token=${{ secrets.GITHUB_TOKEN }}" >> "$GITHUB_OUTPUT"
                    echo "Falling back to default GITHUB_TOKEN (will NOT have Projects v2 write; only docs/labels will update)."
                  fi

            - name: Run sync (validate on push, chosen mode otherwise)
              env:
                  GITHUB_TOKEN: ${{ steps.select-token.outputs.token }}
                  # Set to 'false' once project connectivity confirmed; leave true to avoid failing early during setup.
                  ALLOW_MISSING_PROJECT: 'true'
              run: |
                  MODE=${{ github.event_name == 'push' && 'validate' || github.event.inputs.mode }}
                  echo "Running in mode: $MODE"
                  node scripts/sync-implementation-order.mjs $MODE
            - name: Ensure required type labels exist
              if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
              env:
                  GITHUB_TOKEN: ${{ steps.select-token.outputs.token }}
              run: |
                  if [ -f scripts/sync-labels.mjs ]; then
                    echo "Syncing labels...";
                    node scripts/sync-labels.mjs;
                  else
                    echo "Label sync script missing, skipping.";
                  fi

            - name: Commit regenerated docs (apply / resequence only)
              if: github.event_name == 'workflow_dispatch' && contains(fromJSON('["apply","resequence"]'), github.event.inputs.mode)
              env:
                  GITHUB_TOKEN: ${{ steps.select-token.outputs.token }}
              run: |
                  if git diff --quiet docs/roadmap.md roadmap/implementation-order.json; then
                    echo "No doc changes to commit."; exit 0; fi
                  git config user.name 'github-actions[bot]'
                  git config user.email 'github-actions[bot]@users.noreply.github.com'
                  git add docs/roadmap.md roadmap/implementation-order.json
                  git commit -m 'chore(roadmap): sync implementation order'
                  git push
