name: Update open milestone delivery order (issue closed)

on:
  issues:
    types: [closed]

concurrency:
  group: issue-closed-update-open-milestones-${{ github.repository }}-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      models: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Update open milestone delivery orders (AI)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Optional: GitHub Models model name (defaults to gpt-4o-mini if not set)
          GITHUB_MODELS_MODEL: ${{ vars.GITHUB_MODELS_MODEL }}
          # Optional: override endpoint (defaults to https://models.inference.ai.azure.com)
          GITHUB_MODELS_BASE_URL: ${{ vars.GITHUB_MODELS_BASE_URL }}
        run: node scripts/update-open-milestones-on-issue-closed.mjs --repo ${{ github.repository }} --issue ${{ github.event.issue.number }} --apply
