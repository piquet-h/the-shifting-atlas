name: CI

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]
    workflow_dispatch: {}

permissions:
    contents: read
    pull-requests: read

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect Changed Areas
        runs-on: ubuntu-latest
        outputs:
            frontend_changed: ${{ steps.changed.outputs.frontend }}
            a11y_changed: ${{ steps.changed.outputs.a11y }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Paths filter
              id: changed
              uses: dorny/paths-filter@v3
              with:
                  filters: |
                      frontend:
                        - 'frontend/**'
                        - 'frontend/api/**'
                      a11y:
                        - 'frontend/**'
                        - 'docs/ux/**'
                      backend:
                        - 'backend/**'
                      shared:
                        - 'shared/**'

    lint-typecheck:
        name: Lint & Typecheck
        runs-on: ubuntu-latest
        timeout-minutes: 12
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup & Install
              uses: ./.github/actions/node-workspace-setup
            - name: Prelint dependency sanity
              run: npm run prelint
            - name: Lint
              run: npm run lint
            - name: Typecheck
              run: npm run typecheck
            - name: (Optional) Upload ESLint report placeholder
              if: failure()
              run: echo "Add ESLint report upload here if desired."

    tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: lint-typecheck
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup & Install
              uses: ./.github/actions/node-workspace-setup
            - name: Build (TypeScript project refs)
              run: npm run build:ts
            - name: Run tests
              run: npm test --workspaces --if-present
            - name: Upload coverage artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage
                  path: coverage
                  if-no-files-found: ignore

    accessibility:
        name: Accessibility (axe)
        needs: [lint-typecheck, changes]
        if: ${{ needs.changes.outputs.a11y_changed == 'true' && github.event_name == 'pull_request' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup & Install
              uses: ./.github/actions/node-workspace-setup
            - name: Build frontend
              run: npm run build -w frontend
            - name: Axe scan
              run: npm run a11y
            - name: Upload axe report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: axe-report
                  path: frontend/axe-report
                  if-no-files-found: ignore
