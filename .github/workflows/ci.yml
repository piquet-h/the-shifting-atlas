name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read
  packages: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changed Areas
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.changed.outputs.frontend }}
      a11y_changed: ${{ steps.changed.outputs.a11y }}
      backend_changed: ${{ steps.changed.outputs.backend }}
      shared_changed: ${{ steps.changed.outputs.shared }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Paths filter
        id: changed
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
            a11y:
              - 'frontend/**'
              - 'docs/ux/**'
            backend:
              - 'backend/**'
            shared:
              - 'shared/**'

  lint-typecheck:
    name: Lint & Typecheck (matrix)
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        pkg: [shared, backend, frontend]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            shared/package-lock.json
            backend/package-lock.json
            frontend/package-lock.json
          registry-url: 'https://npm.pkg.github.com'
          scope: '@piquet-h'
          always-auth: true

      - name: Install dependencies (${{ matrix.pkg }})
        run: cd ${{ matrix.pkg }} && npm ci

      - name: Lint (${{ matrix.pkg }})
        run: |
          if [ "${{ matrix.pkg }}" = "frontend" ]; then exts=".ts,.tsx"; else exts=".ts"; fi
          cd ${{ matrix.pkg }} && npx eslint 'src' --ext $exts

      - name: Typecheck (${{ matrix.pkg }})
        run: cd ${{ matrix.pkg }} && npm run typecheck

      - name: Upload ESLint placeholder (on failure)
        if: failure()
        run: echo "(placeholder)"

  tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    needs: lint-typecheck
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            shared/package-lock.json
            backend/package-lock.json
            frontend/package-lock.json
          registry-url: 'https://npm.pkg.github.com'
          scope: '@piquet-h'
          always-auth: true

      # Auth handled automatically by setup-node via GITHUB_TOKEN
      - name: Install shared dependencies
        run: cd shared && npm ci

      - name: Install backend dependencies
        run: cd backend && npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build shared
        run: cd shared && npm run build

      - name: Build backend
        run: cd backend && npm run build

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Run shared tests (coverage)
        run: cd shared && npm run test:cov

      - name: Run backend tests (coverage)
        run: cd backend && npm run test:cov

      - name: Run frontend tests
        run: cd frontend && npm test || true

      - name: Collect coverage
        run: |
          mkdir -p coverage
          if [ -d shared/coverage ]; then cp -r shared/coverage coverage/shared; fi
          if [ -d backend/coverage ]; then cp -r backend/coverage coverage/backend; fi
          if [ -d frontend/coverage ]; then cp -r frontend/coverage coverage/frontend; fi
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
          if-no-files-found: ignore

  accessibility:
    name: Accessibility (axe)
    needs: [lint-typecheck, changes]
    if: ${{ needs.changes.outputs.a11y_changed == 'true' && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            shared/package-lock.json
            backend/package-lock.json
            frontend/package-lock.json
          registry-url: 'https://npm.pkg.github.com'
          scope: '@piquet-h'
          always-auth: true

      # Auth handled automatically by setup-node via GITHUB_TOKEN

      - name: Install shared dependencies
        run: cd shared && npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build shared
        run: cd shared && npm run build

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Axe scan
        run: cd frontend && npm run a11y

      - name: Upload axe report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: axe-report
          path: frontend/axe-report
          if-no-files-found: ignore

  summary:
    name: CI Summary
    needs: [lint-typecheck, tests, accessibility]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo '## CI Summary' >> $GITHUB_STEP_SUMMARY
          echo '* Lint & Typecheck: ${{ needs.lint-typecheck.result }}' >> $GITHUB_STEP_SUMMARY
          echo '* Tests: ${{ needs.tests.result }}' >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.accessibility.result }}" != "" ]; then echo '* Accessibility: ${{ needs.accessibility.result }}' >> $GITHUB_STEP_SUMMARY; else echo '* Accessibility: (skipped)' >> $GITHUB_STEP_SUMMARY; fi
