name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read
  packages: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changed Areas
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.changed.outputs.frontend }}
      a11y_changed: ${{ steps.changed.outputs.a11y }}
      backend_changed: ${{ steps.changed.outputs.backend }}
      shared_changed: ${{ steps.changed.outputs.shared }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Paths filter
        id: changed
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
            a11y:
              - 'frontend/**'
              - 'docs/ux/**'
            backend:
              - 'backend/**'
            shared:
              - 'shared/**'

  lint-typecheck:
    name: Lint & Typecheck (matrix)
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        pkg: [shared, backend, frontend]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            shared/package-lock.json
            backend/package-lock.json
            frontend/package-lock.json
          registry-url: 'https://npm.pkg.github.com'
          scope: '@piquet-h'
          always-auth: true

      - name: Install dependencies (${{ matrix.pkg }})
        run: cd ${{ matrix.pkg }} && npm ci

      - name: Lint (${{ matrix.pkg }})
        run: |
          if [ "${{ matrix.pkg }}" = "frontend" ]; then exts=".ts,.tsx"; else exts=".ts"; fi
          cd ${{ matrix.pkg }} && npx eslint 'src' --ext $exts

      - name: Typecheck (${{ matrix.pkg }})
        run: cd ${{ matrix.pkg }} && npm run typecheck

      - name: Upload ESLint placeholder (on failure)
        if: failure()
        run: echo "(placeholder)"

  tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    needs: lint-typecheck
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            shared/package-lock.json
            backend/package-lock.json
            frontend/package-lock.json
          registry-url: 'https://npm.pkg.github.com'
          scope: '@piquet-h'
          always-auth: true

      # Auth handled automatically by setup-node via GITHUB_TOKEN
      - name: Install shared dependencies
        run: cd shared && npm ci

      - name: Install backend dependencies
        run: cd backend && npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build shared
        run: cd shared && npm run build

      - name: Build backend
        run: cd backend && npm run build

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Validate unit tests are isolated
        run: |
          echo "Validating test layer separation..."
          
          # Define exception files (tests that legitimately test configuration logic)
          EXCEPTIONS=(
            "backend/test/unit/persistenceConfigStrict.test.ts"
            "backend/test/unit/appInsightsSampling.test.ts"
            "backend/test/unit/gremlinConfig.binding.test.ts"
            "backend/test/unit/nullTelemetryClient.test.ts"
          )
          
          # Build grep exclude pattern
          EXCLUDE_PATTERN=""
          for file in "${EXCEPTIONS[@]}"; do
            EXCLUDE_PATTERN="$EXCLUDE_PATTERN --exclude=$(basename $file)"
          done
          
          # Check for PERSISTENCE_MODE manipulation (excluding exception files)
          echo "Checking for PERSISTENCE_MODE manipulation..."
          if grep -r "process.env.PERSISTENCE_MODE" backend/test/unit/ $EXCLUDE_PATTERN 2>/dev/null; then
            echo "ERROR: Unit tests must not manipulate PERSISTENCE_MODE (except configuration tests)"
            echo "Found violations in files listed above. These tests should either:"
            echo "  1. Use UnitTestFixture which handles config via DI, or"
            echo "  2. Be moved to integration tests if they need specific persistence modes"
            exit 1
          fi
          
          # Check for direct repository instantiation
          echo "Checking for direct repository instantiation..."
          if grep -r "new InMemory.*Repository\|new Cosmos.*Repository" backend/test/unit/ 2>/dev/null; then
            echo "ERROR: Unit tests must not instantiate repository implementations directly"
            echo "Found violations in files listed above. Use fixture.getXxxRepository() instead."
            exit 1
          fi
          
          # Check for setupTestContainer with explicit mode (excluding DI tests)
          echo "Checking for setupTestContainer with explicit mode..."
          if grep -r "setupTestContainer.*'cosmos'\|setupTestContainer.*'memory'" backend/test/unit/ --exclude=nullTelemetryClient.test.ts --exclude=mockRepositories.test.ts 2>/dev/null; then
            echo "ERROR: Unit tests must use UnitTestFixture only (not setupTestContainer with explicit mode)"
            echo "Found violations in files listed above. Use UnitTestFixture which automatically uses 'mock' mode."
            exit 1
          fi
          
          echo "âœ“ Test layer separation validation passed"

      - name: Run shared tests (coverage)
        run: cd shared && npm run test:cov

      - name: Run backend tests (coverage)
        run: cd backend && npm run test:cov

      - name: Run frontend tests
        run: cd frontend && npm test || true

      - name: Collect coverage
        run: |
          mkdir -p coverage
          if [ -d shared/coverage ]; then cp -r shared/coverage coverage/shared; fi
          if [ -d backend/coverage ]; then cp -r backend/coverage coverage/backend; fi
          if [ -d frontend/coverage ]; then cp -r frontend/coverage coverage/frontend; fi
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
          if-no-files-found: ignore

  accessibility:
    name: Accessibility (axe)
    needs: [lint-typecheck, changes]
    if: ${{ needs.changes.outputs.a11y_changed == 'true' && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            shared/package-lock.json
            backend/package-lock.json
            frontend/package-lock.json
          registry-url: 'https://npm.pkg.github.com'
          scope: '@piquet-h'
          always-auth: true

      # Auth handled automatically by setup-node via GITHUB_TOKEN

      - name: Install shared dependencies
        run: cd shared && npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build shared
        run: cd shared && npm run build

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Axe scan
        run: cd frontend && npm run a11y

      - name: Upload axe report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: axe-report
          path: frontend/axe-report
          if-no-files-found: ignore

  validate-prompts:
    name: Validate Prompt Templates
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.shared_changed == 'true' }}
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: shared/package-lock.json
          registry-url: 'https://npm.pkg.github.com'
          scope: '@piquet-h'
          always-auth: true

      - name: Install shared dependencies
        run: cd shared && npm ci

      - name: Build shared
        run: cd shared && npm run build

      - name: Validate prompt templates
        run: node scripts/validate-prompts.mjs

      - name: Bundle prompt templates
        run: node scripts/bundle-prompts.mjs

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: prompt-bundle
          path: shared/dist/prompts/prompts.bundle.json
          if-no-files-found: warn

  summary:
    name: CI Summary
    needs: [lint-typecheck, tests, accessibility, validate-prompts]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo '## CI Summary' >> $GITHUB_STEP_SUMMARY
          echo '* Lint & Typecheck: ${{ needs.lint-typecheck.result }}' >> $GITHUB_STEP_SUMMARY
          echo '* Tests: ${{ needs.tests.result }}' >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.accessibility.result }}" != "" ]; then echo '* Accessibility: ${{ needs.accessibility.result }}' >> $GITHUB_STEP_SUMMARY; else echo '* Accessibility: (skipped)' >> $GITHUB_STEP_SUMMARY; fi
          if [ "${{ needs.validate-prompts.result }}" != "" ]; then echo '* Prompt Validation: ${{ needs.validate-prompts.result }}' >> $GITHUB_STEP_SUMMARY; else echo '* Prompt Validation: (skipped)' >> $GITHUB_STEP_SUMMARY; fi
