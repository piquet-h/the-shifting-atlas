name: CI

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]
    workflow_dispatch: {}

permissions:
    contents: read
    pull-requests: read

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect Changed Areas
        runs-on: ubuntu-latest
        outputs:
            frontend_changed: ${{ steps.changed.outputs.frontend }}
            a11y_changed: ${{ steps.changed.outputs.a11y }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Paths filter
              id: changed
              uses: dorny/paths-filter@v3
              with:
                  filters: |
                      frontend:
                        - 'frontend/**'
                        - 'frontend/api/**'
                      a11y:
                        - 'frontend/**'
                        - 'docs/ux/**'
                      backend:
                        - 'backend/**'
                      shared:
                        - 'shared/**'

    lint-typecheck:
        name: Lint & Typecheck
        runs-on: ubuntu-latest
        timeout-minutes: 12
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup & Install
              uses: ./.github/actions/node-workspace-setup
            - name: Prelint dependency sanity
              run: npm run prelint
            - name: Lint
              run: npm run lint
            - name: Typecheck
              run: npm run typecheck
            - name: (Optional) Upload ESLint report placeholder
              if: failure()
              run: echo "Add ESLint report upload here if desired."

    tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: lint-typecheck
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup & Install
              uses: ./.github/actions/node-workspace-setup
            - name: Build (composite refs)
              run: npm run build
            - name: Run tests
              run: npm test --workspaces --if-present
            - name: Upload coverage artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage
                  path: coverage
                  if-no-files-found: ignore

    accessibility:
        name: Accessibility (axe)
        needs: [lint-typecheck, changes]
        if: ${{ needs.changes.outputs.a11y_changed == 'true' && github.event_name == 'pull_request' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup & Install
              uses: ./.github/actions/node-workspace-setup
            - name: Build shared + frontend (accessibility)
              run: |
                  npm run build -w shared
                  npm run build -w frontend
              # Build shared first so any transient TypeScript compilation (present or future) has emitted d.ts.
            - name: Axe scan
              run: npm run a11y
            - name: Upload axe report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: axe-report
                  path: frontend/axe-report
                  if-no-files-found: ignore

    build-artifacts:
        name: Build Production Artifacts
        needs: [tests]
        if: ${{ github.event_name != 'pull_request' || github.base_ref == 'main' }}
        # We run this for push to main and optionally for PRs targeting main so preview deployments / downstream workflows
        # can reuse build output instead of rebuilding. This keeps deployment workflow lean (downloads artifacts only).
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup & Install
              uses: ./.github/actions/node-workspace-setup
            - name: Build shared (declarations first)
              run: npm run build -w shared
            - name: Install API production deps
              run: npm install --omit=dev --prefix frontend/api --no-audit --no-fund
            - name: Vendor shared into API
              run: node frontend/api/scripts/prepare-deploy.mjs --prefix frontend/api
            - name: Build API (tsc)
              run: npm run build -w frontend/api
            - name: Verify host.json present
              run: |
                  if [ ! -f frontend/api/dist/host.json ]; then echo 'host.json missing in frontend/api/dist' >&2; exit 1; fi
            - name: Build Frontend (Vite)
              run: npm run build -w frontend
            - name: Verify SWA config
              run: |
                  if [ ! -f frontend/dist/staticwebapp.config.json ]; then echo 'staticwebapp.config.json missing in frontend/dist' >&2; exit 1; fi
            - name: Upload shared dist
              uses: actions/upload-artifact@v4
              with:
                  name: shared-dist
                  path: shared/dist
                  if-no-files-found: error
            - name: Upload api dist
              uses: actions/upload-artifact@v4
              with:
                  name: api-dist
                  path: frontend/api/dist
                  if-no-files-found: error
            - name: Upload frontend dist
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-dist
                  path: frontend/dist
                  if-no-files-found: error

    summary:
        name: CI Summary
        needs: [lint-typecheck, tests, accessibility, build-artifacts]
        if: always()
        runs-on: ubuntu-latest
        steps:
            - name: Generate Summary
              run: |
                  echo '## CI Summary' >> $GITHUB_STEP_SUMMARY
                  echo '* Lint & Typecheck: ${{ needs.lint-typecheck.result }}' >> $GITHUB_STEP_SUMMARY
                  echo '* Tests: ${{ needs.tests.result }}' >> $GITHUB_STEP_SUMMARY
                  if [ "${{ needs.accessibility.result }}" != "" ]; then echo '* Accessibility: ${{ needs.accessibility.result }}' >> $GITHUB_STEP_SUMMARY; else echo '* Accessibility: (skipped)' >> $GITHUB_STEP_SUMMARY; fi
                  if [ "${{ needs.build-artifacts.result }}" != "" ]; then echo '* Build Artifacts: ${{ needs.build-artifacts.result }}' >> $GITHUB_STEP_SUMMARY; fi
