name: Frontend Static Web App Deploy

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual redeploy reason'
        required: false

permissions:
  id-token: write # OIDC for azure/login
  contents: read
  packages: read

concurrency:
  group: swa-frontend-prod
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  # Repository Variables expected:
  #   AZURE_SUBSCRIPTION_ID, AZURE_RESOURCE_GROUP, SWA_NAME (optional; derived from last infra deployment output if absent)
  # Required Secrets:
  #   AZURE_CLIENT_ID, AZURE_TENANT_ID (OIDC federated credentials configured in Azure AD)

jobs:
  build-and-deploy-prod:
    name: Build & Deploy (Production)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install JavaScript dependencies
        run: npm ci

      - name: Build frontend (Vite)
        run: npm run build

      - name: Resolve SWA Name
        id: swa_name
        run: |
          if [ -n "${{ vars.SWA_NAME }}" ]; then echo "SWA_NAME=${{ vars.SWA_NAME }}" >> $GITHUB_ENV; fi
          if [ -z "${{ vars.SWA_NAME }}" ]; then
            echo "::warning title=Missing SWA_NAME::Repository variable SWA_NAME not set. Deployment may fail if name required.";
          fi

      - name: Azure Login (OIDC)
        if: env.SWA_NAME != ''
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Apply SWA App Settings (AAD)
        if: env.SWA_NAME != ''
        env:
          SWA_NAME: ${{ env.SWA_NAME }}
          CUSTOMER_CLIENT_ID: ${{ secrets.CUSTOMER_CLIENT_ID }}
          CUSTOMER_TENANT_ID: ${{ secrets.CUSTOMER_TENANT_ID }}
          CUSTOMER_SECRET: ${{ secrets.CUSTOMER_SECRET }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${SWA_NAME:-}" ]; then echo "No SWA_NAME - skip"; exit 0; fi
          # Derive canonical AAD values (prefer CUSTOMER_* overrides)
          AAD_CLIENT_ID="${CUSTOMER_CLIENT_ID:-${AZURE_CLIENT_ID:-}}"
          AAD_TENANT_ID="${CUSTOMER_TENANT_ID:-${AZURE_TENANT_ID:-}}"
          AAD_CLIENT_SECRET="${CUSTOMER_SECRET:-${AZURE_CLIENT_SECRET:-}}"
          kv_pairs=()
          [ -n "${AAD_CLIENT_ID}" ] && kv_pairs+=(AAD_CLIENT_ID="${AAD_CLIENT_ID}")
          [ -n "${AAD_TENANT_ID}" ] && kv_pairs+=(AAD_TENANT_ID="${AAD_TENANT_ID}")
          [ -n "${AAD_CLIENT_SECRET}" ] && kv_pairs+=(AAD_CLIENT_SECRET="${AAD_CLIENT_SECRET}")
          if [ ${#kv_pairs[@]} -eq 0 ]; then echo "No AAD settings to apply"; exit 0; fi
          echo "Applying ${#kv_pairs[@]} app settings to ${SWA_NAME} (values not logged)"
          # Show keys only for audit
          for kv in "${kv_pairs[@]}"; do echo "Key: ${kv%%=*}"; done
          az staticwebapp appsettings set --name "${SWA_NAME}" --setting-names "${kv_pairs[@]}"
          echo "App settings update complete"

      - name: Preflight - Validate deployment token (Production)
        run: |
          if [ -z "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" ]; then
            echo "::error title=Missing AZURE_STATIC_WEB_APPS_API_TOKEN::Secret not set. Obtain it from the Static Web App portal (Deployment token) and add to repository secrets.";
            exit 1;
          fi
          echo "Deployment token appears configured (redacted, length > 0)."

      - name: Deploy to Azure Static Web Apps (Production)
        uses: azure/static-web-apps-deploy@v1
        with:
          action: 'upload'
          # Use source root (frontend) + dist output. We already built via Vite so skip app build.
          app_location: 'frontend'
          output_location: 'dist'
          api_location: ''
          skip_app_build: true
          skip_api_build: true
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        env:
          DEBUG: true
          SWA_NAME: ${{ env.SWA_NAME }}
