---
description: Backend Azure Functions delta instructions (code-first patterns, envelopes, idempotency)
applyTo: 'backend/**'
---

# Backend module instructions (Azure Functions v4 + TypeScript)

These rules apply to anything under `backend/`.

## Architecture (current)

- **Azure Functions v4**, code-first registrations using `@azure/functions`.
- **TypeScript** source under `backend/src/` (build output under `backend/dist/`).
- Dependency injection via **Inversify** (container setup in `backend/src/inversify.config.ts`).
- Persistence config is centralized in `backend/src/persistenceConfig.ts` (do not duplicate env-var lists elsewhere).

Authoritative references:

- Backend overview/workflow: `backend/README.md`
- DI patterns: `docs/architecture/dependency-injection.md`

## Function authoring

- Register Functions in code (no per-function `function.json`).
- Naming:
    - HTTP: `Http<Verb><Thing>` (example: `HttpMovePlayer`)
    - Queue: `Queue<Process><Thing>`
- Keep HTTP handlers low-latency and stateless; enqueue world-side effects instead of blocking.

## DI and client lifecycle

- Do not create Cosmos/Gremlin/telemetry clients per invocation.
- Prefer resolving dependencies via the Inversify container passed through `InvocationContext.extraInputs`.

## Data & validation

- IDs are GUIDs.
- Reuse shared validators and contract types from `@piquet-h/shared` and backend utilities.
- Avoid duplicating schema/contract shapes in backend code; import them.

## Testing

- Follow test layering and fixtures described in `backend/test/TEST_FIXTURE_GUIDE.md`.
- For behavior changes, add tests first (TDD).

## Formatting & Code Style

Prettier is the authoritative formatter. If any prettier errors appear:

```bash
# Auto-fix all prettier formatting errors
npm run format:backend  # from repo root
# OR
npm run format         # from backend/ directory
```

Do NOT manually edit to fix "Delete", "Add", or spacing errors—prettier handles these automatically. After running format, stage and commit the changes.

## Verification gate (CI must be green)

For any change under `backend/`, you MUST ensure these checks pass before considering work "done":

- Format: `npm run format:check:backend` (repo root) OR `npm run format:check` (in `backend/`) – must have no prettier errors
- Lint: `npm run lint:backend` (repo root) OR `npm run lint` (in `backend/`)
- Typecheck: `npm run typecheck:backend` (repo root) OR `npm run typecheck` (in `backend/`)

If CI fails for format/lint/typecheck/tests, you MUST push follow-up commits until required checks are green.

## Safety guardrails

- Never inline telemetry event names (use shared definitions).
- Never commit secrets.
- Never change `@piquet-h/shared` dependency to a `file:` reference.

---

Last reviewed: 2026-01-15
