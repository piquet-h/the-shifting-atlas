{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Performance Operations Dashboard\n\nConsolidated workbook for Gremlin operation performance monitoring: RU consumption, latency percentiles, partition pressure trends, and operation success/failure rates.\n\n**Telemetry Events:** `Graph.Query.Executed`, `Graph.Query.Failed`\n\n**Objective:** Provide comprehensive visibility into Cosmos DB Gremlin operations to detect partition pressure, cost anomalies, and performance degradation before they impact gameplay.\n\n**Related Issues:** #289 (RU & Latency Overview), #290 (RU vs Latency Correlation), #291 (Partition Pressure Trend), #296 (Success/Failure Rate & RU Cost)\n\n**References:** ADR-002 (partition pressure thresholds), docs/observability.md\n"
      },
      "name": "header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "maxru-control",
            "version": "KqlParameterItem/1.0",
            "name": "MaxRuPerInterval",
            "type": 1,
            "label": "MAX_RU_PER_INTERVAL",
            "timeContext": {
              "durationMs": 86400000
            },
            "description": "Total RU capacity per 5-min interval (RU/s * 300). Enables RU% calculations.",
            "value": "120000"
          },
          {
            "id": "threshold-base-control",
            "version": "KqlParameterItem/1.0",
            "name": "SustainedThresholdPercent",
            "type": 1,
            "label": "SUSTAINED_THRESHOLD_PERCENT",
            "timeContext": {
              "durationMs": 86400000
            },
            "description": "Base sustained RU% threshold (amber). High threshold adds offset.",
            "value": "70"
          },
          {
            "id": "high-threshold-offset-control",
            "version": "KqlParameterItem/1.0",
            "name": "HighThresholdOffset",
            "type": 1,
            "label": "HIGH_THRESHOLD_OFFSET",
            "timeContext": {
              "durationMs": 86400000
            },
            "description": "Additional percent above base for red threshold (default 10).",
            "value": "10"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "sustained-threshold-parameter-control"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Gremlin Operation RU & Latency Overview (Issue #289)\nlet timeRange = 24h;\nlet minEvents = 20;\nlet events = customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Executed'\n  | extend operationName = tostring(customDimensions.operationName), latencyMs = todouble(customDimensions.latencyMs), ruCharge = todouble(customDimensions.ruCharge)\n  | where isnotempty(operationName);\nlet totalEvents = toscalar(events | count);\nlet main = events\n  | summarize Calls = count(), AvgRU = round(avg(ruCharge), 2), MaxRU = round(max(ruCharge), 2), P50 = round(percentile(latencyMs, 50), 0), P95 = round(percentile(latencyMs, 95), 0), P99 = round(percentile(latencyMs, 99), 0), MissingRU = countif(isnull(ruCharge) or isnan(ruCharge)) by operationName\n  | extend AvgRUDisplay = iff(MissingRU > 0.3 * Calls, 'n/a', tostring(AvgRU)), MaxRUDisplay = iff(MissingRU > 0.3 * Calls, 'n/a', tostring(MaxRU))\n  | project operationName, Calls, AvgRUDisplay, MaxRUDisplay, P50, P95, P99\n  | order by Calls desc\n  | take 10\n  | extend include = totalEvents >= minEvents;\nlet empty = datatable(operationName:string, Calls:long, AvgRUDisplay:string, MaxRUDisplay:string, P50:real, P95:real, P99:real)[] | extend include = totalEvents < minEvents;\nunion main, empty | where include | project operationName, Calls, AvgRUDisplay, MaxRUDisplay, P50, P95, P99",
        "size": 0,
        "title": "Top Operations by Call Volume (Last 24h)",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Calls",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "AvgRUDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "text": "n/a",
                    "representation": "gray"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "20",
                    "representation": "redBright"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "15",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            },
            {
              "columnMatch": "MaxRUDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "text": "n/a",
                    "representation": "gray"
                  }
                ]
              }
            },
            {
              "columnMatch": "P95",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": ">",
                    "thresholdValue": "600",
                    "representation": "redBright"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "500",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            },
            {
              "columnMatch": "P99",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": ">",
                    "thresholdValue": "600",
                    "representation": "redBright"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "500",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "operation-ru-latency-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// RU & Latency Instability Warning (Issue #289)\nlet timeRange = 24h;\nlet minEvents = 20;\nlet totalEvents = toscalar(customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Executed'\n  | where isnotempty(tostring(customDimensions.operationName))\n  | count);\nlet warn = print strcat('‚ö†Ô∏è INSTABILITY NOTICE: Only ', totalEvents, ' events in last 24h (<', minEvents, '). Percentiles unreliable. Wait for more data.') | extend include = totalEvents < minEvents | project Notice = print_0, include;\nlet empty = datatable(Notice:string, include:bool)[];\nunion warn, empty | where include | project Notice",
        "size": 0,
        "title": "RU & Latency Percentile Stability",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Notice",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "text": "INSTABILITY NOTICE",
                    "representation": "warning"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "ru-latency-instability-warning"
    },
    {
      "type": 1,
      "content": {
        "json": "## RU vs Latency Correlation\n\n**Purpose:** Detect pressure-induced slowdowns by correlating RU charge to latency.\n\n**Interpretation:**\n- Pearson correlation >0.6: Strong positive correlation (rising RU ‚Üí rising latency)\n- Correlation displayed only when sample size ‚â•30\n- Scatter plot helps identify outliers and operational clusters"
      },
      "name": "section-correlation"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// RU vs Latency Correlation - Scatter Plot (Issue #290)\nlet timeRange = 2h;\ncustomEvents\n| where timestamp > ago(timeRange)\n| where name == 'Graph.Query.Executed'\n| extend operationName = tostring(customDimensions.operationName),\n         latencyMs = todouble(customDimensions.latencyMs),\n         ruCharge = todouble(customDimensions.ruCharge)\n| where isnotempty(operationName) and isnotnull(ruCharge) and isnotnull(latencyMs) and latencyMs > 0\n| project timestamp, operationName, ruCharge, latencyMs\n| order by timestamp desc\n| take 1000",
        "size": 0,
        "title": "RU vs Latency Scatter (Last 2h, max 1000 points)",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "scatterchart",
        "chartSettings": {
          "xAxis": "ruCharge",
          "yAxis": [
            "latencyMs"
          ],
          "group": "operationName",
          "seriesLabelSettings": []
        }
      },
      "name": "ru-latency-scatter"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// RU vs Latency Correlation - Trend Line with Correlation Coefficient (Issue #290)\nlet timeRange = 2h;\nlet minSampleSize = 30;\nlet events = customEvents\n| where timestamp > ago(timeRange)\n| where name == 'Graph.Query.Executed'\n| extend operationName = tostring(customDimensions.operationName), latencyMs = todouble(customDimensions.latencyMs), ruCharge = todouble(customDimensions.ruCharge)\n| where isnotempty(operationName) and isnotnull(ruCharge) and isnotnull(latencyMs) and latencyMs > 0;\nevents\n| summarize n = count(), sumX = sum(ruCharge), sumY = sum(latencyMs), sumXY = sum(ruCharge * latencyMs), sumX2 = sum(ruCharge * ruCharge), sumY2 = sum(latencyMs * latencyMs) by operationName\n| extend numerator = (n * sumXY) - (sumX * sumY), denomX = sqrt((n * sumX2) - (sumX * sumX)), denomY = sqrt((n * sumY2) - (sumY * sumY))\n| extend correlation = iff(denomX == 0 or denomY == 0, 0.0, numerator / (denomX * denomY))\n| extend correlation = round(correlation, 3)\n| project operationName, correlation, SampleSize = n, MeetsThreshold = iff(n >= minSampleSize, 'Yes', 'No')\n| order by correlation desc",
        "size": 0,
        "title": "Pearson Correlation: RU vs Latency (sample ‚â•30)",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "correlation",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": ">",
                    "thresholdValue": "0.6",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            },
            {
              "columnMatch": "SampleSize",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue"
              }
            },
            {
              "columnMatch": "MeetsThreshold",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "text": "No",
                    "representation": "gray"
                  },
                  {
                    "operator": "==",
                    "text": "Yes",
                    "representation": "green"
                  }
                ]
              }
            },
            {
              "columnMatch": "Notice",
              "formatter": 1
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "correlation-coefficient-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Correlation Sample Size Warning (Issue #290)\nlet timeRange = 2h;\nlet minSampleSize = 30;\nlet sampleCount = toscalar(customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Executed'\n  | extend operationName = tostring(customDimensions.operationName), latencyMs = todouble(customDimensions.latencyMs), ruCharge = todouble(customDimensions.ruCharge)\n  | where isnotempty(operationName) and isnotnull(ruCharge) and isnotnull(latencyMs) and latencyMs > 0\n  | count);\nlet missingRU = toscalar(customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Executed'\n  | extend ruCharge = todouble(customDimensions.ruCharge), operationName = tostring(customDimensions.operationName)\n  | where isnotempty(operationName) and (isnull(ruCharge) or isnan(ruCharge))\n  | count);\nlet showWarning = sampleCount < minSampleSize;\nlet warningMsg = strcat('‚ö†Ô∏è INSUFFICIENT SAMPLE WARNING: Only ', sampleCount, ' valid events (<', minSampleSize, '). Missing RU events: ', missingRU, '. Correlation coefficients suppressed until threshold met.');\nlet warningRow = datatable(Notice:string)[''] | extend Notice = warningMsg, include = showWarning;\nwarningRow | where include | project Notice",
        "size": 0,
        "title": "Correlation Sample Size Warning (shows only when <30 events)",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Notice",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "text": "INSUFFICIENT SAMPLE WARNING",
                    "representation": "warning"
                  }
                ]
              }
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "correlation-sample-warning"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// RU vs Latency Trend (dual axis) - 5-min buckets (Issue #290)\nlet timeRange = 2h;\nlet bucketSize = 5m;\ncustomEvents\n| where timestamp > ago(timeRange)\n| where name == 'Graph.Query.Executed'\n| extend operationName = tostring(customDimensions.operationName),\n         latencyMs = todouble(customDimensions.latencyMs),\n         ruCharge = todouble(customDimensions.ruCharge)\n| where isnotempty(operationName) and isnotnull(ruCharge) and isnotnull(latencyMs)\n| summarize \n    AvgRU = avg(ruCharge),\n    P95Latency = percentile(latencyMs, 95)\n  by bucket = bin(timestamp, bucketSize)\n| order by bucket asc",
        "size": 0,
        "title": "Average RU vs P95 Latency Trend (5-min buckets, 2h)",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "linechart",
        "chartSettings": {
          "yAxis": [
            "AvgRU",
            "P95Latency"
          ],
          "seriesLabelSettings": [
            {
              "seriesName": "AvgRU",
              "label": "Avg RU",
              "color": "blue"
            },
            {
              "seriesName": "P95Latency",
              "label": "P95 Latency (ms)",
              "color": "orange"
            }
          ]
        }
      },
      "customWidth": "50",
      "name": "ru-latency-trend"
    },
    {
      "type": 1,
      "content": {
        "json": "## Partition Pressure Trend (RU% + 429 Overlay)\n\n**Purpose:** Detect sustained high RU utilization and throttling signals before migration actions are needed.\n\n**Thresholds (ADR-002):**\n- üü° RU% >70% (amber)\n- üî¥ RU% >80% (red)\n- üö® RU% >70% for ‚â•3 consecutive intervals ‚Üí requires investigation\n\n**Configuration:** Set `MAX_RU_PER_INTERVAL` parameter above (e.g., 1000 RU/s √ó 300s = 300000). If not configured, panel displays \"Baseline throughput not configured\" and suppresses % calculation.\n\n**Edge Cases Handled:**\n- Zero RU intervals ‚Üí displays 0%\n- Sparse 429 occurrences ‚Üí renders with appropriate scaling\n- Missing baseline ‚Üí informational state (not error)"
      },
      "name": "section-partition-pressure"
    },
    {
      "type": 1,
      "content": {
        "json": "‚ö†Ô∏è **Baseline throughput not configured** - Set the `MAX_RU_PER_INTERVAL` parameter above to enable RU% calculation. Example: For 1000 RU/s provisioned throughput with 5-minute buckets, use 1000 √ó 300 = 300000."
      },
      "conditionalVisibility": {
        "parameterName": "MaxRuPerInterval",
        "comparison": "isEqualTo",
        "value": ""
      },
      "name": "partition-pressure-config-banner"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Partition Pressure Trend - RU% with 429 overlay (dynamic thresholds + high overlay)\nlet timeRange = 24h;\nlet bucketSize = 5m;\nlet rawMax = '{MaxRuPerInterval:escape}';\nlet hasMax = rawMax != '' and rawMax != '{MaxRuPerInterval:escape}';\nlet parsedMax = todouble(rawMax);\nlet maxRuParam = iff(hasMax and parsedMax > 0, parsedMax, real(null));\nlet baseStr = '{SustainedThresholdPercent:escape}';\nlet baseThreshold = iff(baseStr == '' or baseStr == '{SustainedThresholdPercent:escape}', 70.0, todouble(baseStr));\nlet offsetStr = '{HighThresholdOffset:escape}';\nlet offsetVal = iff(offsetStr == '' or offsetStr == '{HighThresholdOffset:escape}', 10.0, todouble(offsetStr));\nlet highThreshold = baseThreshold + offsetVal;\nlet ruEvents = customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Executed'\n  | extend ruCharge = todouble(customDimensions.ruCharge)\n  | where isnotnull(ruCharge);\nlet failures = customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Failed'\n  | extend statusCode = toint(customDimensions.statusCode)\n  | where statusCode == 429;\nlet allBuckets = range t from ago(timeRange) to now() step bucketSize | project bucket = bin(t, bucketSize);\nlet ruByBucket = ruEvents | summarize TotalRU = sum(ruCharge) by bucket = bin(timestamp, bucketSize);\nlet throttleByBucket = failures | summarize ThrottleCount = count() by bucket = bin(timestamp, bucketSize);\nallBuckets\n| join kind=leftouter ruByBucket on bucket\n| join kind=leftouter throttleByBucket on bucket\n| extend TotalRU = coalesce(TotalRU, 0.0), ThrottleCount = coalesce(ThrottleCount, 0)\n| extend RUPercent = iff(isnotnull(maxRuParam) and maxRuParam > 0, round(100.0 * TotalRU / maxRuParam, 2), real(null))\n| extend RUPercentHigh = iff(isnotnull(RUPercent) and RUPercent > highThreshold, RUPercent, real(null))\n| project timestamp = bucket, RUPercent, RUPercentHigh, ThrottleCount, TotalRU, ThresholdBase = baseThreshold, ThresholdHigh = highThreshold\n| order by timestamp asc",
        "size": 0,
        "title": "RU% and 429 Count (5-min buckets, 24h) ‚Äì Dynamic Thresholds",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "linechart",
        "chartSettings": {
          "yAxis": [
            "RUPercent",
            "RUPercentHigh",
            "ThrottleCount"
          ],
          "seriesLabelSettings": [
            {
              "seriesName": "RUPercent",
              "label": "RU%",
              "color": "blue"
            },
            {
              "seriesName": "RUPercentHigh",
              "label": "RU% (High)",
              "color": "redBright"
            },
            {
              "seriesName": "ThrottleCount",
              "label": "429 Count",
              "color": "redBright"
            },
            {
              "seriesName": "ThresholdBase",
              "label": "Base Threshold (%)",
              "color": "orange"
            },
            {
              "seriesName": "ThresholdHigh",
              "label": "+Offset Threshold (%)",
              "color": "red"
            }
          ]
        }
      },
      "name": "partition-pressure-chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Sustained High RU Hotspots (dynamic thresholds & baseline guard)\nlet timeRange = 24h;\nlet bucketSize = 5m;\nlet rawMax = '{MaxRuPerInterval:escape}';\nlet hasMax = rawMax != '' and rawMax != '{MaxRuPerInterval:escape}';\nlet parsedMax = todouble(rawMax);\nlet maxRu = iff(hasMax and parsedMax > 0, parsedMax, 0.0);\nlet baseStr = '{SustainedThresholdPercent:escape}';\nlet baseThreshold = iff(baseStr == '' or baseStr == '{SustainedThresholdPercent:escape}', 70.0, todouble(baseStr));\nlet offsetStr = '{HighThresholdOffset:escape}';\nlet offsetVal = iff(offsetStr == '' or offsetStr == '{HighThresholdOffset:escape}', 10.0, todouble(offsetStr));\nlet ruEvents = customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Executed'\n  | extend ruCharge = todouble(customDimensions.ruCharge)\n  | where isnotnull(ruCharge);\nlet ruByBucket = ruEvents\n  | summarize TotalRU = sum(ruCharge) by bucket = bin(timestamp, bucketSize);\nlet high = ruByBucket\n  | where maxRu > 0\n  | extend RUPercent = round(100.0 * TotalRU / maxRu, 2)\n  | where RUPercent > baseThreshold\n  | project StartTime = bucket, Message = strcat('RU% >', tostring(baseThreshold), ' at ', tostring(bucket), ' (', RUPercent, '%)'), include = true;\nlet info = print StartTime=datetime(null), Message= strcat('‚ÑπÔ∏è Configure MAX_RU_PER_INTERVAL (>0) and/or adjust thresholds Base=', tostring(baseThreshold), ' Offset=', tostring(offsetVal), ' to enable sustained alerts'), include = maxRu == 0;\nunion high, info | where include | project StartTime, Message | order by StartTime asc nulls last",
        "size": 0,
        "title": "Sustained Pressure Alerts (RU >ThresholdBase%)",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Message",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "text": "SUSTAINED HIGH RU",
                    "representation": "critical"
                  },
                  {
                    "operator": "Default",
                    "representation": "info"
                  }
                ]
              }
            },
            {
              "columnMatch": "ConsecutiveIntervals",
              "formatter": 4,
              "formatOptions": {
                "palette": "red"
              }
            },
            {
              "columnMatch": "AvgRU",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": ">",
                    "thresholdValue": "80",
                    "representation": "redBright"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "70",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            },
            {
              "columnMatch": "MaxRU",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": ">",
                    "thresholdValue": "80",
                    "representation": "redBright"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "70",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "partition-pressure-annotation"
    },
    {
      "type": 1,
      "content": {
        "json": "## Operation Success/Failure Rate & RU Cost\n\n**Purpose:** Provide visibility into reliability and cost efficiency to prioritize high-cost or failure-prone operations.\n\n**Thresholds:**\n- üü° Failure Rate >2% (amber)\n- üî¥ Failure Rate >5% (red)\n\n**Note:** Operations with <10 total calls are listed separately as low-volume."
      },
      "name": "section-success-failure"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Operation Success/Failure Rate & RU Cost Table (Issue #296)\nlet timeRange = 24h;\nlet minCalls = 10;\nlet successEvents = customEvents\n| where timestamp > ago(timeRange)\n| where name == 'Graph.Query.Executed'\n| extend operationName = tostring(customDimensions.operationName),\n         ruCharge = todouble(customDimensions.ruCharge),\n         latencyMs = todouble(customDimensions.latencyMs)\n| where isnotempty(operationName);\nlet failureEvents = customEvents\n| where timestamp > ago(timeRange)\n| where name == 'Graph.Query.Failed'\n| extend operationName = tostring(customDimensions.operationName)\n| where isnotempty(operationName);\n// Aggregate success\nlet successAgg = successEvents\n| summarize \n    SuccessCalls = count(),\n    TotalRU = sum(ruCharge),\n    MissingRU = countif(isnull(ruCharge)),\n    P95Latency = percentile(latencyMs, 95)\n  by operationName;\n// Aggregate failures\nlet failureAgg = failureEvents\n| summarize FailedCalls = count() by operationName;\n// Join and compute metrics\nsuccessAgg\n| join kind=leftouter failureAgg on operationName\n| extend FailedCalls = coalesce(FailedCalls, 0)\n| extend TotalCalls = SuccessCalls + FailedCalls\n| extend FailureRate = round(100.0 * FailedCalls / TotalCalls, 2)\n| extend AvgRUSuccess = iff(MissingRU > 0.3 * SuccessCalls, 0.0, TotalRU / SuccessCalls)\n| extend AvgRUDisplay = iff(MissingRU > 0.3 * SuccessCalls, \"n/a\", tostring(round(AvgRUSuccess, 2)))\n| extend RUPerCall = iff(AvgRUSuccess > 0, round(AvgRUSuccess, 2), 0.0)\n| extend RUPerCallDisplay = iff(MissingRU > 0.3 * SuccessCalls, \"n/a\", tostring(RUPerCall))\n| extend Category = iff(TotalCalls < minCalls, \"Low Volume\", \"Normal\")\n| project operationName, SuccessCalls, FailedCalls, FailureRate, AvgRUDisplay, RUPerCallDisplay, P95Latency = round(P95Latency, 0), Category\n| order by TotalCalls = SuccessCalls + FailedCalls desc",
        "size": 0,
        "title": "Operation Reliability & RU Cost (Last 24h)",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "SuccessCalls",
              "formatter": 4,
              "formatOptions": {
                "palette": "green"
              }
            },
            {
              "columnMatch": "FailedCalls",
              "formatter": 4,
              "formatOptions": {
                "palette": "red"
              }
            },
            {
              "columnMatch": "FailureRate",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": ">",
                    "thresholdValue": "5",
                    "representation": "redBright"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "2",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            },
            {
              "columnMatch": "AvgRUDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "text": "n/a",
                    "representation": "gray"
                  }
                ]
              }
            },
            {
              "columnMatch": "RUPerCallDisplay",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "text": "n/a",
                    "representation": "gray"
                  }
                ]
              }
            },
            {
              "columnMatch": "P95Latency",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": ">",
                    "thresholdValue": "600",
                    "representation": "redBright"
                  },
                  {
                    "operator": ">",
                    "thresholdValue": "500",
                    "representation": "orange"
                  },
                  {
                    "operator": "Default",
                    "representation": "green"
                  }
                ]
              }
            },
            {
              "columnMatch": "Category",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "text": "Low Volume",
                    "representation": "gray"
                  },
                  {
                    "operator": "Default",
                    "representation": "blue"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "operation-reliability-table"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Missing RU Warning Banner (Issue #296)\nlet timeRange = 24h;\nlet successEvents = customEvents\n  | where timestamp > ago(timeRange)\n  | where name == 'Graph.Query.Executed'\n  | extend operationName = tostring(customDimensions.operationName), ruCharge = todouble(customDimensions.ruCharge)\n  | where isnotempty(operationName);\nlet totalEvents = toscalar(successEvents | count);\nlet missingRU = toscalar(successEvents | where isnull(ruCharge) | count);\nlet missingPercent = iff(totalEvents > 0, round(100.0 * missingRU / totalEvents, 1), 0.0);\nlet warn = print strcat('‚ö†Ô∏è RU DATA INCOMPLETE: ', missingPercent, '% of success events missing ruCharge values. RU/Call metrics may be unreliable. Check instrumentation.') | extend Warning = print_0, Status='', include = missingPercent > 30.0 | project Warning, Status, include;\nlet ok = print '‚úÖ RU data coverage adequate (<30% missing)' | extend Warning='', Status=print_0, include = missingPercent <= 30.0 | project Warning, Status, include;\nunion warn, ok | where include | project Warning, Status",
        "size": 0,
        "title": "RU Data Quality Check",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Warning",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "text": "RU DATA INCOMPLETE",
                    "representation": "warning"
                  }
                ]
              }
            },
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "text": "adequate",
                    "representation": "success"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "ru-data-quality-banner"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Overall Failure Rate Notes (Issue #296)\nlet timeRange = 24h;\nlet successEvents = customEvents | where timestamp > ago(timeRange) | where name == 'Graph.Query.Executed';\nlet failureEvents = customEvents | where timestamp > ago(timeRange) | where name == 'Graph.Query.Failed';\nlet totalSuccess = toscalar(successEvents | count);\nlet totalFailure = toscalar(failureEvents | count);\nlet totalCalls = totalSuccess + totalFailure;\nlet overallFailureRate = iff(totalCalls > 0, round(100.0 * totalFailure / totalCalls, 2), 0.0);\nlet lowPriority = print strcat('‚ÑπÔ∏è LOW PRIORITY: Overall failure rate is ', overallFailureRate, '% (<1%). Reliability good.') | extend include = overallFailureRate < 1.0 and totalCalls >= 100 | project Note = print_0, include;\nlet insufficient = print strcat('‚ÑπÔ∏è INSUFFICIENT DATA: Only ', totalCalls, ' total operations in 24h. Wait for more traffic.') | extend include = totalCalls < 100 | project Note = print_0, include;\nlet monitor = print strcat('‚ö†Ô∏è MONITOR: Overall failure rate is ', overallFailureRate, '% (‚â•1%). Review high-failure operations above.') | extend include = overallFailureRate >= 1.0 and totalCalls >= 100 | project Note = print_0, include;\nunion lowPriority, insufficient, monitor | where include | project Note",
        "size": 0,
        "title": "Optimization Priority Assessment",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Note",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "text": "LOW PRIORITY",
                    "representation": "info"
                  },
                  {
                    "operator": "contains",
                    "text": "INSUFFICIENT DATA",
                    "representation": "info"
                  },
                  {
                    "operator": "contains",
                    "text": "MONITOR",
                    "representation": "warning"
                  }
                ]
              }
            }
          ]
        }
      },
      "name": "optimization-priority-notes"
    },
    {
      "type": 1,
      "content": {
        "json": "### Interpretation Guide\n\n**RU & Latency Overview:**\n- High P95/P99 latency (>500ms): Operation may be bottlenecked or experiencing pressure\n- High AvgRU operations: Review query efficiency and consider optimization\n- \"n/a\" RU values: >30% events missing RU data; telemetry incomplete\n\n**Correlation Analysis:**\n- Strong correlation (>0.6): Rising RU directly impacts latency ‚Üí potential partition pressure\n- Weak/negative correlation: Latency driven by factors other than RU (network, complexity)\n- Sample size warning: Correlations require ‚â•30 events per operation for statistical reliability\n\n**Edge Cases:**\n- **Missing ruCharge**: Events without RU data are omitted from scatter plot and correlation calculation. Check \"Missing RU count\" in warning messages.\n- **LatencyMs=0**: These rare events are filtered out to avoid skewing correlation calculations.\n- **High RU with low latency**: Legitimate pattern showing efficient high-throughput operations; correlation will be weak or negative (expected).\n- **Very high RU outliers**: Scatter plot may show extreme RU values. Future enhancement: outlier removal toggle (RU > median √ó configurable factor).\n\n**Partition Pressure:**\n- Sustained RU% >70%: Monitor closely; prepare migration plan\n- 429 spikes: Immediate throttling; review hot operations\n- Configure MAX_RU_PER_INTERVAL for accurate % calculation\n\n**Reliability & Cost:**\n- High failure rate (>5%): Investigate error patterns\n- High RU/Call with low success rate: Expensive failing operations\n- Low volume operations: Not enough data for reliable metrics\n- AvgRU(Success): Average RU per successful call (excludes failures)\n- RU/Call Ratio: Same as AvgRU for cost-per-operation analysis\n\n**Export & Query Documentation:**\n- Full export instructions (CSV, JSON, Azure CLI): See `docs/observability.md` ¬ß Performance Operations Dashboard\n- Kusto query examples for external analysis tools (R, Python, Excel)\n- Workbook JSON configuration export via Azure Portal Advanced Editor"
      },
      "name": "interpretation-guide"
    }
  ],
  "_exportMetadata": {
    "slug": "performance-operations-dashboard",
    "exportedAt": "2025-11-18",
    "note": "This file is auto-generated from Azure Application Insights workbook. Do not edit directly. Use scripts/observability/export-workbooks.mjs to update."
  }
}
