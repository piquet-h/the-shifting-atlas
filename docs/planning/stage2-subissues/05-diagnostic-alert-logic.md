# Sub-Issue 5: Add Diagnostic Alert Issue Logic for High Variance

**Parent Issue:** #83 - Automation Stage 2: Predictive Scheduling Integration  
**Labels:** `scope:devx`, `enhancement`, `scope:observability`, `M0`  
**Milestone:** M0 Foundation

## Context

When variance exceeds thresholds, the system should automatically create a diagnostic alert issue. This provides visibility to maintainers and tracks remediation efforts without requiring manual monitoring.

## Requirements

### 1. Alert Issue Creation Conditions

**Create alert when:**
- Median rolling variance > 25% (RED threshold)
- Sample size ‚â• 5 issues in 30-day window
- No open alert issue exists for current period

**Skip alert when:**
- Variance ‚â§ 25%
- Sample size < 5 (insufficient data)
- Alert already open for current period
- Stage 2 disabled (future feature flag)

### 2. Alert Period Definition

**Period:** Weekly (Monday-Sunday)

**Period Key:** `YYYY-Www` (ISO week format, e.g., `2025-W03`)

**Rationale:**
- Weekly cadence balances responsiveness vs noise
- ISO week provides clear, standard period boundaries
- Aligns with typical sprint/iteration cycles

### 3. Alert Issue Structure

#### Title Format

```
[VARIANCE ALERT] Schedule accuracy below threshold (Week YYYY-Www)
```

**Example:** `[VARIANCE ALERT] Schedule accuracy below threshold (Week 2025-W03)`

#### Body Template

```markdown
## üìä Schedule Variance Alert

**Alert Level:** {{ALERT_LEVEL_EMOJI}} {{ALERT_LEVEL}}  
**Median Variance:** {{MEDIAN_VARIANCE}}% (threshold: 25%)  
**Period:** Week {{WEEK_KEY}} ({{START_DATE}} to {{END_DATE}})  
**Issues Analyzed:** {{SAMPLE_SIZE}}  
**Generated:** {{TIMESTAMP}}

---

### Variance Distribution

| Metric | Value |
|--------|-------|
| **Minimum** | {{MIN_VARIANCE}}% |
| **25th Percentile** | {{P25_VARIANCE}}% |
| **Median** | {{MEDIAN_VARIANCE}}% |
| **75th Percentile** | {{P75_VARIANCE}}% |
| **Maximum** | {{MAX_VARIANCE}}% |
| **Mean** | {{MEAN_VARIANCE}}% |
| **Std Deviation** | {{STDDEV_VARIANCE}}% |

---

### Top Variance Contributors

{{#each TOP_CONTRIBUTORS}}
**#{{issueNumber}}** ‚Äì {{title}}
- **Provisional:** {{provisional.start}} to {{provisional.finish}} ({{provisional.duration}} days)
- **Actual:** {{actual.start}} to {{actual.finish}} ({{actual.duration}} days)
- **Variance:** {{variance}}% ({{finishDelta}} days late)
- **Confidence:** {{confidence}}

{{/each}}

---

### Analysis

{{#if PATTERNS}}
**Detected Patterns:**
{{#each PATTERNS}}
- {{this}}
{{/each}}
{{else}}
No clear patterns detected. Variance may be due to random factors or insufficient sample size.
{{/if}}

**Potential Root Causes:**
- Estimation model may not account for specific complexity factors
- Historical samples may not represent current work types
- Upstream dependencies or blockers not captured in estimates
- Scope creep or requirements changes during implementation

---

### Recommended Actions

**Immediate:**
- [ ] Review top variance contributors for commonalities
- [ ] Check if specific scope/type combinations consistently over/under-estimate
- [ ] Validate historical sample quality (closed issues with accurate dates)

**Short-term:**
- [ ] Consider adjusting DEFAULT_DURATION_DAYS for affected scope/type
- [ ] Add explicit duration labels (e.g., `size:small`, `size:large`) to reduce estimation variance
- [ ] Investigate if external factors (reviews, CI, dependencies) are causing delays

**Long-term (if variance persists):**
- [ ] Collect more granular completion data (sub-tasks, time logs)
- [ ] Implement confidence intervals instead of point estimates
- [ ] Consider parallel work streams (Stage 3) to reduce cascading delays

---

### Escalation Criteria

- **Current:** Alert created (variance >25%)
- **Escalate:** If median variance >25% for 2 consecutive weeks
- **Rollback:** If median variance >25% for 3 consecutive weeks, consider Stage 2 rollback per exit criteria

---

### Automation Status

- **Next calculation:** {{NEXT_CALC_TIME}}
- **Auto-close:** When median variance <25% for 7 consecutive days
- **Manual override:** Close this issue to suppress alerts for current period

**Related:** #83 (Automation Stage 2)

---

*This alert was automatically generated by `.github/workflows/calculate-variance.yml`*
```

#### Label Strategy

**Required labels:**
- `scope:devx`
- `scope:observability`
- `automated-alert`
- `variance-alert`

**Dynamic labels:**
- `variance-red` (if median > 25%)
- `variance-critical` (if median > 40%)
- `escalated` (if persists for 2+ weeks)

#### Assignees

**Default:** None (alert is informational)

**Optional:** Assign to project maintainer if variance critical (>40%)

### 4. Alert Issue Lifecycle

#### State Machine

```
[NO ALERT] 
    ‚Üì (variance > 25%, no open alert)
[CREATED] 
    ‚Üì (variance still > 25%, same period)
[UPDATED] 
    ‚Üì (variance < 25% for 7 days)
[CLOSED - RESOLVED]

[CREATED] 
    ‚Üì (variance > 25% for 14 days)
[ESCALATED] 
    ‚Üì (manual intervention)
[CLOSED - MANUAL]

[CREATED] 
    ‚Üì (new period starts)
[CLOSED - PERIOD_END] ‚Üí [CREATED (new period)]
```

#### Update Logic

**When to update existing alert:**

1. **Same period, variance still high:**
   - Update variance metrics
   - Update top contributors
   - Append update note to body
   - Update timestamp

2. **Variance improving but still high:**
   - Update metrics
   - Note improvement trend
   - Keep alert open until 7 consecutive days below threshold

3. **New high-variance issue in same period:**
   - Add to top contributors
   - Recalculate distribution
   - Update body

**Update Marker:**

Append to issue body:
```markdown
---

### Update: {{TIMESTAMP}}

**New Median Variance:** {{MEDIAN_VARIANCE}}% (was {{PREVIOUS_MEDIAN}}%)  
**Trend:** {{TREND_ICON}} {{TREND_TEXT}}  
**Issues Analyzed:** {{SAMPLE_SIZE}} (was {{PREVIOUS_SAMPLE_SIZE}})

{{#if NEW_CONTRIBUTORS}}
**New Contributors:**
{{#each NEW_CONTRIBUTORS}}
- #{{issueNumber}} ‚Äì {{variance}}%
{{/each}}
{{/if}}
```

#### Auto-Close Conditions

**Close alert when:**

1. **Variance resolved:**
   - Median variance < 25% for 7 consecutive days
   - Add closing comment explaining resolution

2. **Period ended:**
   - New week started
   - Variance may still be high (new alert created for new period)
   - Add closing comment with final stats

3. **Manual close:**
   - Maintainer closes manually
   - Respect manual close; don't reopen unless new period

**Closing Comment:**

```markdown
## ‚úÖ Alert Resolved

**Final Variance:** {{FINAL_VARIANCE}}%  
**Duration:** {{DAYS_OPEN}} days  
**Resolution:** {{RESOLUTION_REASON}}

{{#if IMPROVEMENTS_MADE}}
**Actions Taken:**
{{#each IMPROVEMENTS_MADE}}
- {{this}}
{{/each}}
{{/if}}

Variance monitoring continues. Next alert will be created if variance exceeds threshold again.

*Auto-closed by variance monitoring workflow*
```

### 5. Alert Aggregation Strategy

**Single Issue Per Period:** One alert issue per ISO week.

**Rationale:**
- Avoids spam (don't create issue per high-variance item)
- Provides weekly snapshot for review
- Easier to track trends over time

**Alternative (NOT recommended):**
- One issue per high-variance item: Too noisy
- One persistent alert updated forever: Hard to track historical changes

### 6. Pattern Detection

**Analyze variance contributors for patterns:**

```javascript
function detectPatterns(issues) {
    const patterns = []
    
    // Group by scope
    const byScope = groupBy(issues, i => i.metadata.scope)
    for (const [scope, items] of byScope) {
        if (items.length >= 3 && mean(items.map(i => i.variance)) > 0.30) {
            patterns.push(`Scope ${scope} consistently over-estimates (${items.length} issues, ${mean(...)% avg variance)`)
        }
    }
    
    // Group by type
    const byType = groupBy(issues, i => i.metadata.type)
    for (const [type, items] of byType) {
        if (items.length >= 3 && mean(items.map(i => i.variance)) > 0.30) {
            patterns.push(`Type ${type} consistently under-estimates (${items.length} issues)`)
        }
    }
    
    // Check confidence correlation
    const highConfHiVar = issues.filter(i => i.confidence === 'high' && i.variance > 0.30)
    if (highConfHiVar.length >= 3) {
        patterns.push(`High-confidence estimates still have high variance (${highConfHiVar.length} issues) - historical samples may be stale`)
    }
    
    // Check duration bias
    const avgProvDuration = mean(issues.map(i => i.provisional.duration))
    const avgActualDuration = mean(issues.map(i => i.actual.duration))
    if (avgActualDuration > avgProvDuration * 1.3) {
        patterns.push(`Systematic under-estimation: actual durations average ${((avgActualDuration / avgProvDuration - 1) * 100).toFixed(0)}% longer`)
    }
    
    return patterns
}
```

### 7. Escalation Logic

**Escalation Trigger:** Variance >25% for 2 consecutive weeks

**Escalation Actions:**
1. Add `escalated` label to alert issue
2. Assign to project maintainer
3. Add escalation comment:

```markdown
## ‚ö†Ô∏è Escalation Notice

Variance has been above threshold for 2 consecutive weeks. This indicates a systematic issue with provisional scheduling accuracy.

**Consecutive High-Variance Weeks:** 2  
**Current Variance:** {{MEDIAN_VARIANCE}}%  
**Target:** <10%

**Required Actions:**
- Review estimation model parameters
- Consider increasing DEFAULT_DURATION_DAYS
- Analyze root causes in top variance contributors
- Decide if Stage 2 rollback is needed (exit criteria: variance >25% for 3 weeks)

@{{MAINTAINER_HANDLE}}
```

**Rollback Warning:** If variance >25% for 3 weeks, add `rollback-candidate` label and comment:

```markdown
## üö® Rollback Candidate

Stage 2 exit criteria met: variance >25% for 3 consecutive weeks.

Consider rolling back provisional scheduling feature per Stage 2 rollback plan:
1. Disable provisional comment posting
2. Stop variance tracking
3. Keep provisional-schedules.json for analysis
4. Document issues discovered
5. Plan fixes for re-attempt

Refer to #83 for rollback procedure.
```

## Acceptance Criteria

- [ ] Alert issue creation implemented
- [ ] Alert period definition (ISO week) implemented
- [ ] Title format follows convention
- [ ] Body template includes all required sections
- [ ] Top contributors correctly identified (top 5)
- [ ] Pattern detection logic implemented
- [ ] Update logic preserves alert history
- [ ] Auto-close logic implemented (7 days below threshold)
- [ ] Period-end close logic implemented
- [ ] Escalation logic implemented (2 weeks)
- [ ] Rollback warning logic implemented (3 weeks)
- [ ] Labels applied correctly
- [ ] Single alert per period enforced
- [ ] Manual close respected (no reopen until new period)
- [ ] Closing comment includes resolution details

## Technical Specifications

### Alert Manager Module

**Location:** `scripts/shared/alert-manager.mjs`

**Exports:**

```javascript
export {
    createOrUpdateAlert,
    closeAlert,
    checkEscalation,
    detectPatterns,
    findOpenAlert,
    getWeekKey
}
```

**Function Signatures:**

```javascript
async function createOrUpdateAlert(varianceData, periodKey) {
    // 1. Check if alert exists for period
    const existing = await findOpenAlert(periodKey)
    
    if (existing) {
        // Update existing
        await updateAlertIssue(existing.number, varianceData)
    } else {
        // Create new
        await createAlertIssue(varianceData, periodKey)
    }
}

async function closeAlert(issueNumber, reason, finalVariance) {
    // Post closing comment
    // Close issue
    // Remove from tracking
}

async function checkEscalation(issueNumber, consecutiveWeeks) {
    if (consecutiveWeeks >= 2) {
        await escalateAlert(issueNumber)
    }
    if (consecutiveWeeks >= 3) {
        await warnRollback(issueNumber)
    }
}

function detectPatterns(issues) {
    // Returns array of pattern strings
}

async function findOpenAlert(periodKey) {
    // Search open issues with:
    // - Label: variance-alert
    // - Title contains period key
    // Return issue or null
}

function getWeekKey(date = new Date()) {
    // Returns ISO week key: YYYY-Www
}
```

### Alert Creation Script

**Script:** `scripts/create-variance-alert.mjs`

```javascript
#!/usr/bin/env node
// Usage: npm run create:variance-alert
// Called by calculate-variance.yml workflow

// 1. Load variance data from provisional-schedules.json
// 2. Check threshold
// 3. If threshold exceeded:
//    - Get current week key
//    - Find or create alert issue
//    - Update with latest data
// 4. Check escalation
// 5. Output summary
```

### Workflow Integration

**Workflow:** `.github/workflows/calculate-variance.yml`

```yaml
- name: Check Variance Threshold
  id: threshold
  run: |
    VARIANCE=$(node scripts/get-median-variance.mjs)
    echo "variance=$VARIANCE" >> $GITHUB_OUTPUT
    if (( $(echo "$VARIANCE > 0.25" | bc -l) )); then
      echo "alert_needed=true" >> $GITHUB_OUTPUT
    else
      echo "alert_needed=false" >> $GITHUB_OUTPUT
    fi

- name: Create or Update Alert Issue
  if: steps.threshold.outputs.alert_needed == 'true'
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: npm run create:variance-alert

- name: Check Auto-Close Conditions
  if: steps.threshold.outputs.alert_needed == 'false'
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: npm run check:alert-close
```

### Alert Tracking File

**Location:** `roadmap/variance-alerts.json`

**Purpose:** Track alert history and escalation state

```json
{
    "alerts": [
        {
            "periodKey": "2025-W03",
            "issueNumber": 456,
            "createdAt": "2025-01-15T00:30:00Z",
            "closedAt": "2025-01-22T00:30:00Z",
            "peakVariance": 0.32,
            "finalVariance": 0.18,
            "daysOpen": 7,
            "resolution": "resolved",
            "escalated": false
        }
    ],
    "consecutiveHighVarianceWeeks": 1,
    "lastCheckAt": "2025-01-22T00:30:00Z"
}
```

## Testing Strategy

### Unit Tests

**Location:** `scripts/shared/alert-manager.test.mjs`

Test cases:
1. Create new alert
2. Update existing alert
3. Close alert (resolved)
4. Close alert (period end)
5. Detect escalation
6. Pattern detection (scope bias)
7. Pattern detection (type bias)
8. Pattern detection (confidence correlation)
9. Week key generation
10. Find open alert

### Integration Tests

1. **Full alert lifecycle:**
   - High variance detected
   - Alert created
   - Variance persists, alert updated
   - Variance resolves, alert closed

2. **Escalation flow:**
   - Week 1: Alert created
   - Week 2: Escalation triggered
   - Week 3: Rollback warning added

3. **Multiple periods:**
   - Week 1 alert closes at period end
   - Week 2 new alert created
   - No duplicate alerts

### Manual Testing

1. Simulate high variance scenario
2. Verify alert issue created with correct format
3. Simulate variance improvement
4. Verify alert auto-closes
5. Simulate persistent high variance
6. Verify escalation labels/comments

## Documentation Impact

### Files to Update

1. **docs/developer-workflow/implementation-order-automation.md**
   - Add "Diagnostic Alert Issues" section
   - Document alert lifecycle and escalation
   - Link to variance configuration

2. **README.md**
   - Add variance alert workflow to automation section
   - Mention alert issues may be created automatically

3. **.github/copilot-instructions.md**
   - Document alert issue format
   - Note that `automated-alert` issues should not be manually created

## Rollback Procedure

If alert issues cause problems:
1. Disable alert creation in workflow (comment out step)
2. Manually close open alert issues with explanation
3. Keep variance calculation running (for data collection)
4. Re-enable after fixing with updated logic

## Dependencies

- Sub-issue #4 (Variance Calculation) must be completed
- Requires `issues: write` permission in workflow
- GitHub API rate limits: Max 5000 requests/hour (unlikely to hit with weekly alerts)

## Estimated Duration

3 days

## Notes

- Alert issues are informational; not blocking work
- Consider adding webhook/Slack notification for critical alerts (future)
- Pattern detection is heuristic; false positives possible
- Weekly cadence may need tuning based on project velocity
